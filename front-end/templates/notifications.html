<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Уведомления</title>
</head>

<body>
    <h1>Уведомления</h1>

    <ul id="notifications">
        <!-- Уведомления будут добавляться здесь динамически через WebSocket -->
    </ul>

    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            alert('Вы не авторизованы');
            window.location.href = '/login/';
        }

        const wsUrl = `ws://${window.location.host}/ws/notifications/`;
        const notificationSocket = new WebSocket(wsUrl);

        notificationSocket.onopen = function () {
            console.log("WebSocket подключен.");
        };

        notificationSocket.onmessage = function (e) {
            try {
                const data = JSON.parse(e.data);
                console.log("Получено сообщение от WebSocket:", data);

                if (data.type === 'notification') {
                    // Добавление нового уведомления
                    const notificationsList = document.getElementById("notifications");
                    const newNotification = document.createElement("li");
                    newNotification.id = `notification-${data.notification_id}`;
                    newNotification.textContent = data.message;
                    notificationsList.appendChild(newNotification);
                    console.log(`Добавлено уведомление с ID ${data.notification_id}`);
                } else if (data.type === 'delete') {
                    // Удаление уведомления
                    const notificationId = data.notification_id;
                    console.log(`Удаление уведомления с ID ${notificationId}`);
                    const notificationElement = document.getElementById(`notification-${notificationId}`);
                    if (notificationElement) {
                        notificationElement.remove();
                        console.log(`Уведомление с ID ${notificationId} удалено.`);
                    } else {
                        console.warn(`Уведомление с ID ${notificationId} не найдено.`);
                    }
                }
            } catch (error) {
                console.error("Ошибка обработки сообщения:", error);
            }
        };

        notificationSocket.onerror = function (e) {
            console.error('Ошибка WebSocket:', e);
        };

        notificationSocket.onclose = function (e) {
            console.warn('WebSocket закрыт:', e.code, e.reason);
            if (e.code !== 1000) {
                alert('Соединение с сервером было закрыто. Перезагрузите страницу.');
            }
        };
    </script>
</body>

</html>